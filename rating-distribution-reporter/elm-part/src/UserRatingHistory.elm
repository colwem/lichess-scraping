module UserRatingHistory exposing (UserRatingHistory)

import Http
import Html exposing (div)
import Json.Decode as Decode exposing (Decoder)
import Time exposing (Month(..))
import Time.Extra


fetch : String -> (Result Http.Error UserRatingHistory -> msg)-> Cmd msg
fetch username msgCons =
  Http.get
    { url = "https://lichess.org/api/user/" ++ username ++ "/rating-history"
    , expect = Http.expectJson msgCons decoder
    }

type UserRatingHistory =
  UserRatingHistory (List PerfTypeRatingHistory)

type alias PerfTypeRatingHistory =
  { perfType : String
  , points : List DatedRating
  }

type alias DatedRating =
  { date : Time.Posix
  , rating : Float
  }

decoder : Decoder UserRatingHistory
decoder  =
  Decode.map UserRatingHistory (Decode.list perfTypeRatingHistoryDecoder)

perfTypeRatingHistoryDecoder : Decoder PerfTypeRatingHistory
perfTypeRatingHistoryDecoder =
  Decode.map2 PerfTypeRatingHistory
    ( Decode.field "name" Decode.string)
    ( Decode.field "points" (Decode.list datedRatingDecoder ))

datedRatingDecoder : Decoder DatedRating
datedRatingDecoder =
  Decode.map4 toDatedRating
    (Decode.index 0 Decode.int)
    (Decode.index 1 Decode.int)
    (Decode.index 2 Decode.int)
    (Decode.index 3 Decode.float)

toDatedRating : Int -> Int -> Int -> Float -> DatedRating
toDatedRating year month day rating =
  DatedRating
    (Time.Extra.partsToPosix Time.utc
      { year = year
      , month = toMonth month
      , day = day
      , hour = 0
      , minute = 0
      , second = 0
      , millisecond = 0
      })
    rating

toMonth : Int -> Month
toMonth month =
  case month of
    0 -> Jan
    1 -> Feb
    2 -> Mar
    3 -> Apr
    4 -> May
    5 -> Jun
    6 -> Jul
    7 -> Aug
    8 -> Sep
    9 -> Oct
    10 -> Nov
    11 -> Dec
    _  -> Dec


main =
  let
      happy = Decode.decodeString decoder testString
  in
      div [] []



testString : String
testString =
  """
[{"name":"Bullet","points":[[2017,5,18,978],[2018,3,22,1114],[2018,3,23,1159],[2018,6,13,1159]]},{"name":"Blitz","points":[[2017,3,23,1335],[2017,5,18,798],[2017,8,11,792],[2017,9,26,890],[2017,9,27,925],[2017,9,29,946],[2017,9,30,929],[2017,10,11,945],[2017,10,14,967],[2017,10,16,1002],[2017,10,18,992],[2017,10,22,998],[2017,10,23,1018],[2017,10,27,1034],[2017,11,2,1050],[2017,11,3,1056],[2017,11,4,1064],[2017,11,5,1060],[2017,11,8,1061],[2017,11,12,1067],[2017,11,13,1071],[2017,11,17,1096],[2017,11,18,1118],[2017,11,21,1155],[2017,11,22,1169],[2017,11,24,1239],[2017,11,25,1241],[2017,11,26,1232],[2017,11,27,1225],[2017,11,28,1306],[2017,11,31,1350],[2018,0,1,1315],[2018,0,4,1328],[2018,0,8,1359],[2018,0,9,1371],[2018,0,10,1354],[2018,0,14,1339],[2018,1,23,1328],[2018,1,24,1300],[2018,2,5,1298],[2018,3,21,1316],[2018,3,22,1306],[2018,3,23,1296],[2018,3,26,1329],[2018,3,27,1301],[2018,3,30,1312],[2018,4,1,1334],[2018,4,29,1344],[2018,5,22,1351],[2018,6,2,1353],[2018,6,29,1411],[2018,7,3,1442],[2018,8,12,1442],[2018,8,17,1456],[2018,10,3,1439]]},{"name":"Rapid","points":[[2017,11,25,1481],[2018,0,8,1456],[2018,1,15,1458],[2018,1,24,1492],[2018,1,28,1518],[2018,2,5,1515],[2018,2,10,1500],[2018,2,16,1499],[2018,3,22,1517],[2018,3,26,1505],[2018,5,27,1513],[2018,6,5,1501],[2018,6,22,1510],[2018,7,2,1516],[2018,7,3,1520],[2018,7,15,1515],[2018,7,25,1512],[2018,8,13,1472],[2018,8,17,1498],[2018,8,19,1506],[2018,8,20,1514],[2018,9,6,1529],[2018,11,15,1536],[2018,11,16,1508],[2018,11,31,1552],[2019,0,6,1564],[2019,0,7,1560],[2019,0,24,1575],[2019,0,25,1556],[2019,1,11,1574],[2019,1,25,1576],[2019,1,26,1568],[2019,2,2,1549],[2019,2,4,1545],[2019,2,27,1561],[2019,2,28,1586],[2019,3,11,1592],[2019,3,17,1601]]},{"name":"Classical","points":[[2017,3,12,1371],[2017,3,13,1464],[2017,3,14,1409],[2017,3,17,1452],[2017,3,18,1525],[2017,3,19,1528],[2017,3,22,1531],[2017,3,23,1544],[2017,3,24,1516],[2017,3,26,1497],[2017,4,2,1468],[2017,4,6,1450],[2017,5,18,1383],[2017,8,13,1373],[2017,8,14,1360],[2017,8,21,1349],[2017,8,22,1354],[2017,8,25,1382],[2017,8,27,1409],[2017,8,28,1420],[2017,9,4,1385],[2017,9,9,1376],[2017,9,13,1378],[2017,9,28,1397],[2017,10,12,1397],[2017,10,15,1388],[2017,10,16,1400],[2017,10,18,1422],[2017,10,19,1421],[2017,10,20,1413],[2017,10,22,1435],[2017,10,23,1445],[2017,10,26,1473],[2017,11,1,1488],[2017,11,2,1504],[2017,11,3,1540],[2017,11,5,1538],[2017,11,6,1514],[2017,11,7,1521],[2017,11,8,1518],[2017,11,12,1530],[2017,11,13,1519],[2017,11,14,1508],[2017,11,16,1509],[2017,11,17,1554],[2017,11,21,1560],[2017,11,22,1538],[2017,11,23,1522],[2017,11,24,1529],[2017,11,28,1518],[2017,11,31,1509],[2018,0,4,1502],[2018,0,5,1497],[2018,0,7,1511],[2018,0,8,1524],[2018,0,13,1531],[2018,0,14,1541],[2018,0,16,1552],[2018,0,19,1565],[2018,0,20,1579],[2018,0,25,1586],[2018,0,26,1591],[2018,0,28,1601],[2018,1,1,1599],[2018,1,3,1609],[2018,1,5,1603],[2018,1,6,1616],[2018,1,10,1635],[2018,1,11,1649],[2018,1,17,1648],[2018,1,18,1637],[2018,1,25,1626],[2018,2,2,1628],[2018,2,5,1632],[2018,2,9,1624],[2018,2,10,1613],[2018,2,11,1603],[2018,2,15,1619],[2018,2,16,1630],[2018,2,18,1630],[2018,2,23,1644],[2018,2,25,1655],[2018,2,28,1659],[2018,2,29,1674],[2018,3,1,1662],[2018,3,8,1673],[2018,3,13,1677],[2018,3,15,1667],[2018,3,21,1658],[2018,3,22,1667],[2018,3,26,1677],[2018,3,28,1675],[2018,4,3,1657],[2018,4,5,1668],[2018,4,6,1676],[2018,4,9,1683],[2018,4,10,1691],[2018,4,11,1679],[2018,4,18,1678],[2018,4,19,1679],[2018,4,20,1680],[2018,4,25,1690],[2018,5,3,1678],[2018,5,7,1688],[2018,5,10,1674],[2018,5,11,1688],[2018,5,12,1687],[2018,5,15,1679],[2018,5,17,1686],[2018,5,21,1681],[2018,5,22,1688],[2018,5,30,1691],[2018,6,1,1689],[2018,6,4,1677],[2018,6,8,1688],[2018,6,15,1700],[2018,6,19,1689],[2018,6,26,1673],[2018,7,1,1686],[2018,7,3,1697],[2018,7,10,1686],[2018,7,12,1678],[2018,7,19,1664],[2018,7,20,1674],[2018,7,24,1681],[2018,8,1,1684],[2018,8,8,1689],[2018,8,9,1694],[2018,8,16,1699],[2018,8,20,1688],[2018,8,28,1684],[2018,8,29,1696],[2018,9,3,1701],[2018,9,4,1706],[2018,9,7,1716],[2018,9,11,1707],[2018,9,14,1718],[2018,9,17,1727],[2018,9,21,1728],[2018,9,25,1728],[2018,9,26,1739],[2018,10,2,1749],[2018,10,4,1738],[2018,10,10,1724],[2018,10,11,1734],[2018,10,17,1737],[2018,10,18,1721],[2018,10,24,1705],[2018,10,29,1696],[2018,11,8,1685],[2018,11,16,1697],[2018,11,21,1706],[2018,11,22,1696],[2018,11,28,1703],[2019,0,3,1695],[2019,0,10,1698],[2019,0,13,1711],[2019,0,18,1694],[2019,0,20,1685],[2019,0,24,1700],[2019,0,26,1710],[2019,1,3,1721],[2019,1,10,1720],[2019,1,17,1710],[2019,1,22,1719],[2019,1,23,1730],[2019,2,1,1722],[2019,2,3,1732],[2019,2,7,1731],[2019,2,15,1720],[2019,2,22,1730],[2019,2,31,1719],[2019,3,7,1709],[2019,3,13,1700],[2019,4,19,1689],[2019,4,23,1679],[2019,5,1,1693],[2019,5,8,1703],[2019,5,15,1715]]},{"name":"Correspondence","points":[[2017,8,25,1704],[2017,8,27,1607],[2017,8,28,1817],[2017,8,29,1870],[2017,8,30,1876],[2017,9,1,1837],[2017,9,2,1877],[2017,9,3,1812],[2017,9,4,1831],[2017,9,15,1837],[2017,9,17,1817],[2017,9,18,1825],[2017,9,21,1807],[2017,9,23,1824],[2017,9,24,1819],[2017,9,27,1837],[2017,9,28,1867],[2017,9,30,1840],[2017,9,31,1851],[2018,0,4,1832],[2018,2,11,1821],[2018,2,14,1817],[2018,8,13,1790],[2019,3,7,1804],[2019,3,8,1816],[2019,3,11,1869],[2019,3,18,1878],[2019,3,20,1891],[2019,3,21,1893],[2019,3,23,1905],[2019,3,24,1889],[2019,3,28,1925],[2019,4,2,1915],[2019,4,10,1929],[2019,4,14,1936],[2019,4,24,1943],[2019,5,6,1959],[2019,5,13,1963]]},{"name":"Chess960","points":[[2018,5,15,1553],[2018,5,24,1453],[2018,6,6,1396],[2018,6,12,1465],[2018,6,13,1420],[2018,6,22,1469],[2018,6,29,1424],[2018,7,26,1405],[2018,7,29,1432],[2018,8,7,1466],[2018,8,13,1460],[2018,8,19,1436],[2018,8,30,1414],[2018,10,1,1411],[2018,10,8,1384],[2018,10,13,1404],[2018,10,23,1437],[2018,11,1,1431],[2018,11,7,1424],[2018,11,15,1401],[2019,0,10,1440],[2019,0,19,1438],[2019,0,24,1459],[2019,1,4,1443],[2019,1,8,1418],[2019,1,16,1438],[2019,1,22,1426],[2019,2,2,1454],[2019,5,6,1446]]},{"name":"King of the Hill","points":[]},{"name":"Three-check","points":[]},{"name":"Antichess","points":[]},{"name":"Atomic","points":[[2017,3,23,1314]]},{"name":"Horde","points":[[2017,8,30,1622]]},{"name":"Racing Kings","points":[]},{"name":"Crazyhouse","points":[[2018,6,14,1464],[2018,6,27,1393],[2018,7,4,1625],[2018,7,11,1336],[2018,7,13,1331],[2018,7,22,1452],[2018,8,29,1423],[2018,9,14,1463],[2018,9,19,1438],[2018,9,27,1497],[2018,10,6,1490],[2018,11,9,1500],[2018,11,17,1553],[2018,11,21,1532],[2018,11,29,1557],[2018,11,30,1538],[2019,0,13,1553],[2019,0,14,1536],[2019,0,16,1533],[2019,0,27,1556],[2019,2,23,1538],[2019,2,27,1502],[2019,2,28,1476],[2019,2,31,1504],[2019,3,8,1510],[2019,4,26,1543],[2019,5,3,1546],[2019,5,10,1569]]},{"name":"Training","points":[[2019,1,23,1921],[2019,2,4,1919],[2019,2,5,1928],[2019,2,28,1880],[2019,2,29,1944],[2019,4,17,1991],[2019,4,31,1974]]},{"name":"UltraBullet","points":[]}]
"""
